# GVLとは

https://scrapbox.io/mopp/Ruby_%E3%81%AE_Giant_VM_Lock_(GVL)

- RubyでThreadを書くとOSのThreadに対応するThreadが作られる
- マルチスレッドで動くRubyの正しさを保証するためにGVLという仕組みがある
- GVLは並行性を提供する（スイッチするやつ）
  - NOT 並列性（同時にやるやつ）
- GVLはVM上のstateについてのみ保証する
- GVLはマルチスレッドで動くRubyのデータの正しさを保証するものではない（！）
- 要するに並行で動かすためにRubyのスレッドをOSのスレッドにマッピングするための仕組み
  - これがあるのでちゃんとスレッドが（レースコンディションせずに）並行で動く
- やることがなくなったらGCが動いてスレッドは止まるっぽい
  - Network I/Oなどで待ちが発生するとロックを開放するので他のスレッドが並列で動く
- I/O待ちの発生する処理と内部で処理が完結する軽い処理を組み合わせて別スレッドで動き出すと、ほぼ軽い処理の方でスレッドを独占してしまってネットワーク処理はロック待ちがほとんどで、実行されなかった（！）
- 並列性を提供するのがRactor
  - Ractor使うとそれぞれでGVLを持つので、並列で動く
- レイテンシのためにスレッドを大量に使うことは避けるべき



 
